name: Verify README Setup Instructions

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on push to main (optional, for testing)
  push:
    branches: [ main ]
    paths:
      - 'README.md'
      - 'scripts/verify-readme.js'
      - '.github/workflows/verify-readme.yml'

jobs:
  verify-macos:
    name: Verify on macOS
    runs-on: macos-latest
    # Fix Issue 1: Add permissions for write access
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Need full checkout to commit changes back
          fetch-depth: 0
          # Fix Issue 1: Use token with write permissions
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install verifier dependencies
        run: |
          cd scripts
          npm install js-yaml
      
      - name: Run README verification
        id: verify
        continue-on-error: true
        run: |
          node scripts/verify-readme.js README.md
      
      - name: Upload verification results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verification-results
          path: .github/readme-verifier/results.json
          retention-days: 30
      
      - name: Commit badge updates
        if: always()
        env:
          # Make GITHUB_TOKEN available as environment variable
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Configure git to use token for authentication
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          
          # Check if there are changes
          if git diff --quiet README.md; then
            echo "No changes to commit"
          else
            git add README.md
            git add .github/readme-verifier/results.json
            git commit -m "ðŸ”„ Update README verification badges [skip ci]"
            git push
          fi
      
      - name: Create issue on failure
        if: steps.verify.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('.github/readme-verifier/results.json', 'utf8'));
            
            const failedSteps = results.steps.filter(s => s.status === 'failed');
            
            let body = '## âŒ README Setup Verification Failed\n\n';
            body += `**Environment:** ${results.environment.os} (${results.environment.nodeVersion})\n`;
            body += `**Timestamp:** ${results.timestamp}\n\n`;
            body += '### Failed Steps:\n\n';
            
            failedSteps.forEach(step => {
              body += `- **${step.name}**\n`;
              body += `  - Error: \`${step.error}\`\n`;
              if (step.output) {
                body += `  - Output:\n\`\`\`\n${step.output}\n\`\`\`\n`;
              }
            });
            
            body += '\n---\n';
            body += '*This issue was automatically created by the README verification workflow.*';
            
            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'readme-verification'
            });
            
            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âŒ README Setup Instructions Need Updating',
                body: body,
                labels: ['readme-verification', 'documentation', 'bug']
              });
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: '### New Verification Failure\n\n' + body
              });
            }
      
      - name: Post summary
        if: always()
        run: |
          if [ -f .github/readme-verifier/results.json ]; then
            node -e 'const results = require("./.github/readme-verifier/results.json"); const total = results.steps.length; const success = results.steps.filter(s => s.status === "success").length; const failed = results.steps.filter(s => s.status === "failed").length; const warnings = results.steps.filter(s => s.status === "warning").length; console.log("## Verification Summary"); console.log(""); console.log("| Metric | Value |"); console.log("|--------|-------|"); console.log("| Total Steps | " + total + " |"); console.log("| âœ… Success | " + success + " |"); console.log("| âŒ Failed | " + failed + " |"); console.log("| âš ï¸ Warnings | " + warnings + " |"); console.log("| Success Rate | " + Math.round((success/total)*100) + "% |");' >> $GITHUB_STEP_SUMMARY
          fi